<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Azure Guest Configuration on Azure and DevOops</title>
    <link>https://manbearpiet.github.io/tags/azure-guest-configuration/</link>
    <description>Recent content in Azure Guest Configuration on Azure and DevOops</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-US</language>
    <copyright>Christian Piet (CC BY 4.0)</copyright>
    <lastBuildDate>Wed, 25 Aug 2021 08:07:31 +0100</lastBuildDate>
    <atom:link href="https://manbearpiet.github.io/tags/azure-guest-configuration/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Using Azure Policy to configure your resources</title>
      <link>https://manbearpiet.github.io/posts/applying-guest-configuration-policy/</link>
      <pubDate>Wed, 25 Aug 2021 08:07:31 +0100</pubDate>
      <guid>https://manbearpiet.github.io/posts/applying-guest-configuration-policy/</guid>
      <description>&lt;h1 id=&#34;azure-policy-as-a-configuration-engine&#34;&gt;Azure Policy as a configuration engine?&lt;/h1&gt;&#xA;&lt;p&gt;&lt;figure&gt;&lt;img src=&#34;https://manbearpiet.github.io/images/applying-guest-config/feature.png&#34;&#xA;    alt=&#34;Azure Policy&#34;&gt;&#xA;&lt;/figure&gt;&#xA;&lt;br&gt;&#xA; &lt;/p&gt;&#xA;&lt;h2 id=&#34;azure-policy-guest-configuration&#34;&gt;Azure Policy Guest Configuration&lt;/h2&gt;&#xA;&lt;p&gt;In a previous blog, I showed how to audit your GPO-contained settings&#xA;inside Azure VM&amp;rsquo;s using Azure Policy Guest Configuration. The packaging process&#xA;is a bit too much for some, and in some cases, you only need to perform a few&#xA;configuration settings. Luckily there are some settings you can already&#xA;configure with built-in policies. In this blog, I will show you what Azure&#xA;Policies are and how they are assigned. When you&amp;rsquo;ve read this post, you&amp;rsquo;ll be&#xA;able to assign Azure Policies to configure the state in your Azure environment and&#xA;your Virtual Machines.&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h1 id="azure-policy-as-a-configuration-engine">Azure Policy as a configuration engine?</h1>
<p><figure><img src="/images/applying-guest-config/feature.png"
    alt="Azure Policy">
</figure>
<br>
 </p>
<h2 id="azure-policy-guest-configuration">Azure Policy Guest Configuration</h2>
<p>In a previous blog, I showed how to audit your GPO-contained settings
inside Azure VM&rsquo;s using Azure Policy Guest Configuration. The packaging process
is a bit too much for some, and in some cases, you only need to perform a few
configuration settings. Luckily there are some settings you can already
configure with built-in policies. In this blog, I will show you what Azure
Policies are and how they are assigned. When you&rsquo;ve read this post, you&rsquo;ll be
able to assign Azure Policies to configure the state in your Azure environment and
your Virtual Machines.</p>
<h2 id="assigning-policies-and-policy-initiatives">Assigning policies and policy initiatives</h2>
<h3 id="azure-policy">Azure Policy</h3>
<p>As a recap, Azure Policy is a service Microsoft offers to audit, configure,
and enforce the configuration of Azure resources to govern the state of your
Azure environment. You could say that they are the embodiment of the
&lsquo;desired state&rsquo; of your Azure resources. Azure Policies are defined within the
policy definitions. A policy definition (JSON) defines which resource types and
properties to check for and what effects are supported by
that policy.</p>
<p>Policy effects are operations, which are triggered if the Policy rules have
been violated. Policies can be identified by their unique &lsquo;policy
definition id&rsquo;. More information about Azure Policies can be found on <a href="https://docs.microsoft.com/en-us/azure/governance/policy/overview#overview">Microsoft Docs</a>.</p>
<p>Policy definitions are assigned to resources scopes (resourcegroup(s),
subscriptions or management groups). This assignment has a distinct name and a
policy effect is chosen. For example, when assigning an Azure
Policy which evaluates if Azure Key Vaults have soft-delete in place, you can
choose the action in that assignment to be <code>Deny</code>. This will deny new
resource deployments in the scope the policy is assigned to.</p>
<p>Some policy definitions allow for several effects, such as &ldquo;Audit&rdquo; or &ldquo;Deny&rdquo;.
During the assignment of the policy, you can supply what policy effect you want
executed in case the policy is violated. More information about Azure Policy effects can be
found at <a href="https://docs.microsoft.com/en-us/azure/governance/policy/concepts/effects">Microsoft Docs</a>.</p>
<h3 id="azure-policy-definition-id">Azure Policy Definition ID</h3>
<p>As mentioned earlier, policy definitions are referenced by their id. You can
search for policy- and initiative definitions, using their ID or display name on the Azure Portal.</p>
<figure><img src="/images/applying-guest-config/searchdefinition.png"
    alt="Search Azure Policy Definitions">
</figure>

<p>Azure <strong>built-in</strong> policies can be referenced at each level with the same id
(subscription and Management Group), so the definition id will always be the
same.</p>
<p>Be wary if you&rsquo;re creating <strong>custom policies</strong> and initiatives. These
are stored at the object and level you create them. So if you&rsquo;ve created a
custom policy definition at a Management Group scope, you can apply that to
that MG or resources scopes beneath the MG, but not in other scopes (not
contained beneath that MG).</p>
<p><figure><img src="/images/applying-guest-config/assignment.png"
    alt="Azure Policy Assignment">
</figure>
<br>
 </p>
<p>Another gotcha from the custom policies is that their policy definition id&rsquo;s
differ from built-in policy definitions. The policy definition id of a custom
policy has a reference to the resource scope where the policy definition is stored.</p>
<p>Built in policy definition id&rsquo;s look like this:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="ln">1</span><span class="cl">/providers/Microsoft.Authorization/policyDefinitions/6141c932-9384-44c6-a395-59e4c057d7c9</span></span></code></pre></div><p>vs. custom policy definitions id&rsquo;s</p>
<p>Custom policy definition (id) stored in a Management group:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="ln">1</span><span class="cl">/providers/Microsoft.Management/managementGroups/MGNAME/providers/Microsoft.Authorization/policyDefinitions/0d030380-eff5-415c-8ea0-b4bb4af4bd20</span></span></code></pre></div><p>Custom policy definition (id) stored in a subscription:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="ln">1</span><span class="cl">/subscriptions/0192d01f-1632-4c36-a89e-807d825b5017/providers/Microsoft.Authorization/policyDefinitions/15f09619-2135-47c9-8af6-1f6a271b8f0d</span></span></code></pre></div><p>Azure Policy Initiatives have a similar definition id, but just a small
difference (policySetDefinitions instead of policyDefinitions):</p>
<p>Built-in:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="ln">1</span><span class="cl">/providers/Microsoft.Authorization/policySetDefinitions/75714362-cae7-409e-9b99-a8e5075b7fad</span></span></code></pre></div><p>vs. custom</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="ln">1</span><span class="cl">/providers/Microsoft.Management/managementGroups/MGNAME/providers/Microsoft.Authorization/policySetDefinitions/84317eb8115a47af90ab703c</span></span></code></pre></div><h2 id="assigning-azure-policies">Assigning Azure Policies</h2>
<p>While Azure Policy Definitions are a tool to reach a state, the policy requires
a target resource scope to be applied. The Azure Policy assignment is a
configuration item which contains the following:</p>
<ul>
<li>What resource scope should the policy apply to</li>
<li>What exclusions should there be within the assigned scope</li>
<li>What policy is assigned</li>
<li>What is the name of the assignment</li>
<li>Should the policy be Enforced</li>
<li>Who assigned the policy</li>
<li>Parameter data for policies with parameters</li>
<li>Which Azure Region the Managed Identity should be deployed in (if using DINE/modify
policy effects)</li>
<li>What default text string to display when a resource is not compliant or if a
resource deployment is not compliant.</li>
</ul>
<p>There are multiple methods to assign policies to Azure resource scopes. In my
previous blog I showed how to assign policies using the Azure Portal. I like
using PowerShell, so I&rsquo;ll use that. More methods to assign Azure Policies can be
found on the <a href="https://docs.microsoft.com/en-us/azure/governance/policy/">Microsoft Docs</a> at the Quickstarts tab.</p>
<p>To make it extra interesting, let&rsquo;s configure objects we can&rsquo;t edit in the
Azure portal. For example, settings in a virtual machine OS.</p>
<h3 id="prerequisites">Prerequisites</h3>
<p>We do need to setup a few things before we can configure Azure Policy to make
changes to our VM&rsquo;s.</p>
<p>In your subscription(s):</p>
<ul>
<li>Must have registered the Guest Configuration Resource provider
<ul>
<li>You can do so with PowerShell using:
<ul>
<li><code>Register-AzResourceProvider -ProviderNamespace Microsoft.GuestConfiguration</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>On your VM resources:</p>
<ul>
<li>You must have the <strong>Azure Policy Guest Extension</strong> present on your VM&rsquo;s
<ul>
<li>Can be deployed with an initiative definition:
<ul>
<li><code>/providers/Microsoft.Authorization/policySetDefinitions/12794019-7a00-42cf-95c2-882eed337cc8</code></li>
</ul>
</li>
</ul>
</li>
<li>Have a <strong>System assigned Managed Identity</strong> for your VM
<ul>
<li>The same initiative can be used mentioned above</li>
</ul>
</li>
<li>VM must be a <a href="https://docs.microsoft.com/en-us/azure/governance/policy/concepts/guest-configuration#supported-client-types">supported client</a></li>
<li>Allow outbound traffic on TCP 443 to NSG-tags <code>AzureArcInfrastructure</code> and
<code>Storage</code> or use Private Link</li>
</ul>
<p>Having met all these requirements, we&rsquo;re all set to deploy built-in GC policies.
Documentation for the built-in GC policies is available at <a href="https://docs.microsoft.com/en-us/azure/governance/policy/samples/built-in-policies#guest-configuration">Microsoft Docs</a>.
There&rsquo;s also a built-in <a href="https://docs.microsoft.com/en-us/azure/governance/policy/samples/built-in-initiatives#guest-configuration">policy initiative</a>.</p>
<h2 id="assigning-policies">Assigning policies</h2>
<p>To show the concept, I&rsquo;m using the
<code>Audit Windows machines that are not set to the specified time zone.</code> built-in
Azure Guest Configuration Policy. It&rsquo;s policy definition ID is:
<code>/providers/Microsoft.Authorization/policyDefinitions/4221adbc-5c0f-474f-88b7-037a99e6114c</code>.
In the <a href="https://github.com/Azure/azure-policy/blob/master/built-in-policies/policyDefinitions/Guest%20Configuration/GuestConfiguration_WindowsTimeZone_AINE.json">policy definition</a> the policy parameter timeZone is referenced, but it has no defaultValue. So we&rsquo;re required to supply the parameter when assigning this policy. Assigning the policy will create another unique ID, containing the scope of the assignment and the assignment name (<code>{scope}/providers/Microsoft.Authorization/policyAssignments/{policyAssignmentName}</code>).</p>
<h3 id="audit">Audit</h3>
<p>We start with an Azure Policy that audits the setting on the machine. We&rsquo;ll perform the policy assignment with:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nv">$DefinitionId</span> <span class="p">=</span> <span class="s2">&#34;/providers/Microsoft.Authorization/policyDefinitions/c633f6a2-7f8b-4d9e-9456-02f0f04f5505&#34;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nv">$splat</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="n">Name</span> <span class="p">=</span> <span class="s1">&#39;Audit Windows machines - Timezone - Test&#39;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  <span class="n">Scope</span> <span class="p">=</span> <span class="s2">&#34;/subscriptions/0192d01f-1632-4c36-a89e-807d825b5017&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="n">PolicyParameterObject</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="n">timeZone</span><span class="p">=</span> <span class="s2">&#34;(UTC+01:00) Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  <span class="n">PolicyDefinition</span> <span class="p">=</span> <span class="nb">Get-AzPolicyDefinition</span> <span class="n">-Builtin</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">PolicyDefinitionId</span> <span class="o">-eq</span> <span class="nv">$DefinitionId</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="nb">New-AzPolicyAssignment</span> <span class="nv">@splat</span></span></span></code></pre></div><h3 id="deployifnotexists">DeployIfNotExists</h3>
<p>The policy we assigned in the previous example has <code>AuditIfNotExists</code> as a policy effect. However, we&rsquo;re interested in configuring
Windows Configuration via Azure Policies, instead of auditing.</p>
<p>Some policies can deploy resources or modify existing resources to automate the
steps towards desired state. Deploying and modifying does require a managed
identity for the Assignment, to perform the policy effects. When assigning a
policy with those effects (<code>DeployIfNotExists</code> (DINE) or <code>Modify</code>), the managed identity is assigned the RBAC-role, as defined in the policy definition under the <code>roleDefinitionIds</code>.</p>
<p>Using Azure Policy, we can now also set the timezone used on the machine. We can do so with a policy definition conveniently named: <code>Configure time zone on Windows machines</code>.
This has a roleDefinition property in the policy definition:</p>
<p><code>/providers/microsoft.authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c</code></p>
<p>In the <a href="https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles">built-in roles reference</a> we can see that <code>b24988ac-6180-42a0-ab88-20f7382dd24c</code>, maps to Contributor resource role. The role is assigned to a special type of service principal called a managed identity <a href="https://docs.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/overview">(Microsoft Docs page about managed identities)</a>.</p>
<p>Assigning the policy with a DeployIfNotExists policy, with the -AssignIdentity switch will create the Identity and assign the Contributor role to the Identity. Do mind that you need the proper authorizations to perform this assignment. Otherwise the remediation actions won&rsquo;t be performed.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nv">$DefinitionId</span> <span class="p">=</span>  <span class="s2">&#34;/providers/Microsoft.Authorization/policyDefinitions/6141c932-9384-44c6-a395-59e4c057d7c9&#34;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nv">$splat</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="n">Name</span> <span class="p">=</span> <span class="nb">New-Guid</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  <span class="n">DisplayName</span> <span class="p">=</span> <span class="s1">&#39;Configure time zone on Windows machines - test&#39;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="n">Scope</span> <span class="p">=</span> <span class="s2">&#34;/subscriptions/0192d01f-1632-4c36-a89e-807d825b5017&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">  <span class="n">PolicyParameterObject</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">timeZone</span><span class="p">=</span><span class="s2">&#34;(UTC+01:00) Amsterdam, Berlin, Bern, Rome, Stockholm, Vienna&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">  <span class="n">PolicyDefinition</span> <span class="p">=</span> <span class="nb">Get-AzPolicyDefinition</span> <span class="n">-Builtin</span> <span class="p">|</span> <span class="nb">Where-Object</span> <span class="n">PolicyDefinitionId</span> <span class="o">-eq</span> <span class="nv">$DefinitionId</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">  <span class="n">Location</span> <span class="p">=</span> <span class="s1">&#39;westeurope&#39;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="nb">New-AzPolicyAssignment</span> <span class="nv">@splat</span> <span class="n">-AssignIdentity</span></span></span></code></pre></div><p>After assigning the policy, the same principles apply as with the previous blogpost. Monitoring policy compliance is done with the <code>Compliance</code>-view in the <code>Policy</code>-management blade:</p>
<p><figure><img src="/images/applying-guest-config/compliance.png"
    alt="Azure Policy">
</figure>
<br>
 </p>
<p>Non-compliant resources will not be remediated until a remediation action is performed, a resource deployment is done (including a tag deployment). So don&rsquo;t forget to perform a remediation action or trigger a policy evaluation by adjusting a resource property.</p>
<p>In this case the assignment is done on an Azure Subscription. To remediate non-compliant resources of an assignment, using a remediation task, you have two options. You can remediate per-resource or remediate all the non-compliant resources for the whole assignment.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">Start-AzPolicyRemediation</span> <span class="n">-Name</span> <span class="s2">&#34;RemediationAction&#34;</span> <span class="n">-PolicyAssignmentId</span> <span class="s2">&#34;/subscriptions/0192d01f-1632-4c36-a89e-807d825b5017/providers/Microsoft.Authorization/policyAssignments/b0b59220-dcfa-4dc2-9638-bda2133ed7b4&#34;</span></span></span></code></pre></div><p>Using the name we supplied we can view the changes in the <code>Remediation</code>-view in the <code>Policy</code>-blade. Under the <code>Remediation Tasks</code> we can see the progress of the remediation task. After a few minutes if remediation succeeded, the compliance will show that the previously non-compliant items are remediated. This can take up to 30 minutes. If remediation failed you can check the task and it&rsquo;s deployments (remediation actions use regular resource deployments to change configuration to be compliant).</p>
<h2 id="conclusion-and-next-steps">Conclusion and next steps</h2>
<p>In this blog I&rsquo;ve explained what Azure Policies definitions and assignments are. I&rsquo;ve shown the differences in assigning the policies using Azure PowerShell with the policy actions Audit and DeployIfNotExists. I also showed how you can initiate Remediate Tasks using Azure PowerShell.</p>
]]></content:encoded>
    </item>
    <item>
      <title>Auditing GPOs with Azure Guest Configuration Policy</title>
      <link>https://manbearpiet.github.io/posts/guest-configuration-policy/</link>
      <pubDate>Tue, 02 Feb 2021 08:07:31 +0100</pubDate>
      <guid>https://manbearpiet.github.io/posts/guest-configuration-policy/</guid>
      <description>&lt;h1 id=&#34;os-hardening-security-auditing&#34;&gt;OS-hardening security auditing&lt;/h1&gt;&#xA;&lt;h2 id=&#34;what&#34;&gt;What?&lt;/h2&gt;&#xA;&lt;p&gt;I wanted to check compliance of a security baseline on Azure without first applying it via DSC. My primary goal was to check out how to validate our own internal security controls without using GPO&amp;rsquo;s.&lt;/p&gt;&#xA;&lt;p&gt;Group Policy Objects are frequently used within a windows server domain to push settings, like security controls, and validate/reapply them to prevent configuration drift. My challenge was how to audit these settings, while knowing some customers also use Demilitarized Zones (DMZ&amp;rsquo;s) in Azure. Servers which reside in this network segment are exposed so they are not joined to the domain. But especially these servers do need to be checked on security controls. So there we have our puzzle. How to audit virtual machines on Azure for custom security configurations.&lt;/p&gt;</description>
      <content:encoded><![CDATA[<h1 id="os-hardening-security-auditing">OS-hardening security auditing</h1>
<h2 id="what">What?</h2>
<p>I wanted to check compliance of a security baseline on Azure without first applying it via DSC. My primary goal was to check out how to validate our own internal security controls without using GPO&rsquo;s.</p>
<p>Group Policy Objects are frequently used within a windows server domain to push settings, like security controls, and validate/reapply them to prevent configuration drift. My challenge was how to audit these settings, while knowing some customers also use Demilitarized Zones (DMZ&rsquo;s) in Azure. Servers which reside in this network segment are exposed so they are not joined to the domain. But especially these servers do need to be checked on security controls. So there we have our puzzle. How to audit virtual machines on Azure for custom security configurations.</p>
<h2 id="security-control-audit-mechanism">Security control audit-mechanism</h2>
<p>To prevent me from making another overengineered solution based on our own security baseline, I went looking for reference data. Luckily Microsoft offers their <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-security-baselines">Windows Security Baselines</a> in exported GPO&rsquo;s, so we have some reference data to check for in our VM&rsquo;s. I&rsquo;d almost want to say half of the puzzle is done! You can find the GPO&rsquo;s here <a href="https://www.microsoft.com/en-us/download/details.aspx?id=55319">link</a>.</p>
<p>But this was far from over! I&rsquo;ve written a few Pester testcases for other projects to validate files and settings, but I was not sure how to pull the audit data back again to some internal management panel to monitor compliance and drill down to what setting. All the cool stuff is in later Pester releases, so I&rsquo;d have to update the module on VM&rsquo;s and still exporting/pulling the audit-data was too much of a hassle in my opinion. We have multiple customers but that&rsquo;s just too much links in the chain. So Pester was not going to cut it for me.</p>
<p>So I was looking for an integrated security audit mechanism to prevent me writing everything and increasing the chance of stuff breaking randomly. So I checked out Automation Accounts and PowerShell Desired State Configuration, can&rsquo;t blame a PowerShell user right?, but there was no Audit/Monitor mode without applying the security controls. While I really like having safe environments, I really dislike broken applications due to too strict settings. So even with the <code>ApplyAndMonitor</code> this just would be too invasive to try in live environments. So Azure Automation DSC is off the table too.</p>
<h2 id="something-something-dark">Something, something dark</h2>
<p>I was a bit bugged and unsatisfied in my search for a solution for this challenge, I tend to find things immediately after stopping the search for said things, and I wanted to know more about DSC. To satisfy the knowledge craving I watched a <a href="https://youtu.be/hXS-rzs3Hak">PowerShell Conference EU 2020 video</a> by Gael Colas and Michael Greene, awesome video bit noisy though. I read the outline, but had to stop half way during the video. Boy I missed some nice stuff. I did however spot <code>Azure Policy Guest Configuration</code> on the outline of the talk.</p>
<p>Later on in my search for a solution to the security baseline challenge, I found a <a href="https://docs.microsoft.com/en-us/powershell/scripting/dsc/quickstarts/gpo-quickstart?view=powershell-7.1">quickstart</a> on Microsoft Docs which showed how to create a DSC configuration and .MOF file (compiled DSC configuration) from an exported GPO, which felt a little bit random, but hey let&rsquo;s see how far we can get.</p>
<p>I converted a GPO from the Microsoft Security Baseline and received some errors, but it did deliver both the configuration.ps1 and .MOF. The modules referenced on the <a href="https://github.com/microsoft/BaselineManagement">GitHub page</a> of the module were already installed, so I applied it to a test VM using Azure Automation DSC&rsquo; <code>ApplyAndMonitor</code> configuration. And it workses! Awesome! In case you&rsquo;d want to export your own GPO&rsquo;s you can use <a href="https://docs.microsoft.com/en-us/powershell/module/grouppolicy/backup-gpo?view=win10-ps">Backup-GPO</a> for this.</p>
<p>Later that week I saw a <a href="https://twitter.com/ThomasMaurer/status/1354531440944427008">post</a> on Twitter by Thomas Maurer mentioning <code>Azure Policy Guest Configuration</code>, waaait a minute I saw that before! I read the  Microsoft Docs page and came to the conclusion, this was my missing link to my solution! This was also the moment I realized I had performed the first steps in the <a href="https://docs.microsoft.com/en-us/azure/governance/policy/how-to/guest-configuration-create-group-policy">quickstart</a> on the Docs page, but no harm in doing so then!</p>
<h2 id="azure-policy-guest-configuration">Azure Policy Guest Configuration</h2>
<p>Maybe it&rsquo;s my English reading profiency, but I just couldn&rsquo;t really figure out what the quickstart was guiding me through. Eventually I came to the following conclusion:
Azure Policy Guest Configuration uses a .MOF-file and modules to validate local settings and report the compliance status to Azure Policy.</p>
<ul>
<li>The VM&rsquo;s require a Managed Identity and a VM extensions, both of which can be deployed via a default initiative.</li>
<li>The MOF-file and technical prerequisites must be packaged.</li>
<li>It uses a distinct PowerShell instance and doesn&rsquo;t interfere with DSC if it&rsquo;s already utilized on the VM.</li>
</ul>
<p>The steps to start using Azure Policy Guest Configuration could be summarized to:</p>
<ol>
<li>Create a .MOF file with security controls based on the GPO-export using <code>ConvertFrom-GPO</code> (Baseline Management).</li>
<li>Deploy prerequisites for auditing mechanism</li>
<li>Make a package with configuration using <code>New-GuestConfigurationPackage</code>.</li>
<li>(Maybe test configuration on VM using <code>Test-GuestConfigurationPackage</code>), can also be piped from <code>New-GuestConfigurationPackage</code>.</li>
<li>Use <code>Publish-GuestConfigurationPackage</code> to publish the configuration to a storage container in an Azure Storage Account and produce a sharing link with SAS-token.</li>
<li>Use the link + sas token, displayname, a description, platform specifion and potentially a tag filter, an Azure Policy is created with <code>New-GuestConfigurationPolicy</code>.</li>
<li>Publish the said policy and apply it to a scope.</li>
</ol>
<p>The cmdlets are from the PowerShell module <code>GuestConfiguration</code>. Ok,ok, so far so good.</p>
<h2 id="deployment">Deployment</h2>
<p>We&rsquo;ve a few choices here, we could use an own GPO with settings to be validated, but to make it interesting I&rsquo;ve added steps to download all the Windows Security baselines.
That way you&rsquo;d check your hardening for each server OS-version.</p>
<h3 id="1-creating-a-mof-file">1. Creating a MOF-file</h3>
<p>If you have an exported GPO then you can skip this part to the codeblock with <code>ConvertFrom-GPO</code></p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="cm">&lt;#
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="cm">  All the download links found for Windows Security baselines
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="cm">  Download each zip via it&#39;s link to the current working directory and replace the whitespace-character %20 in the foldername with a space
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="cm">#&gt;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="vm">@</span><span class="p">(</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="s2">&#34;https://download.microsoft.com/download/8/5/C/85C25433-A1B0-4FFA-9429-7E023E7DA8D8/Windows%2010%20Version%201909%20and%20Windows%20Server%20Version%201909%20Security%20Baseline.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="s2">&#34;https://download.microsoft.com/download/8/5/C/85C25433-A1B0-4FFA-9429-7E023E7DA8D8/Windows%2010%20Version%201507%20Security%20Baseline.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="s2">&#34;https://download.microsoft.com/download/8/5/C/85C25433-A1B0-4FFA-9429-7E023E7DA8D8/Windows%2010%20Version%201607%20and%20Windows%20Server%202016%20Security%20Baseline.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="s2">&#34;https://download.microsoft.com/download/8/5/C/85C25433-A1B0-4FFA-9429-7E023E7DA8D8/Windows%2010%20Version%201803%20Security%20Baseline.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="s2">&#34;https://download.microsoft.com/download/8/5/C/85C25433-A1B0-4FFA-9429-7E023E7DA8D8/Windows%2010%20Version%201809%20and%20Windows%20Server%202019%20Security%20Baseline.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="s2">&#34;https://download.microsoft.com/download/8/5/C/85C25433-A1B0-4FFA-9429-7E023E7DA8D8/Windows%2010%20Version%201903%20and%20Windows%20Server%20Version%201903%20Security%20Baseline%20-%20Sept2019Update.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="s2">&#34;https://download.microsoft.com/download/8/5/C/85C25433-A1B0-4FFA-9429-7E023E7DA8D8/Windows%2010%20Version%201909%20and%20Windows%20Server%20Version%201909%20Security%20Baseline.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="s2">&#34;https://download.microsoft.com/download/8/5/C/85C25433-A1B0-4FFA-9429-7E023E7DA8D8/Windows%2010%20Version%202004%20and%20Windows%20Server%20Version%202004%20Security%20Baseline.zip&#34;</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="p">)</span> <span class="p">|</span> <span class="nb">Foreach-Object</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  <span class="nb">Invoke-Webrequest</span> <span class="n">-URI</span> <span class="nv">$_</span> <span class="n">-OutFile</span> <span class="p">(</span><span class="nv">$_</span><span class="p">.</span><span class="py">split</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">)[</span><span class="mf">-1</span><span class="p">].</span><span class="py">replace</span><span class="p">(</span><span class="s1">&#39;%20&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">  <span class="p">}</span></span></span></code></pre></div><p>I&rsquo;m primairly focussed on the <code>Windows 10 Version 2004 and Windows Server Version 2004 Security Baseline.zip</code> so I did:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="c"># Focus on the zip file and unzip the content in the working directory</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nb">Get-ChildItem</span> <span class="s2">&#34;.\Windows 10 Version 2004 and Windows Server Version 2004 Security Baseline.zip&#34;</span> <span class="p">|</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="nb">Expand-archive</span></span></span></code></pre></div><p>Inside the unzipped folder another theres another folder, which contains a <code>GPOs</code> folder. That&rsquo;s what we&rsquo;re looking for!
Now I was a bit bugged, because I had no idea which folder contains what inside the GPO folder (I don&rsquo;t speak GUID). Luckily there&rsquo;s an XML with the correct information.</p>
<figure><img src="/images/guest-configuration-policy/guid.png"
    alt="GUID to GPO">
</figure>






<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="c"># Create an XML-variable object</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="p">[</span><span class="no">xml</span><span class="p">]</span><span class="nv">$xml</span> <span class="p">=</span> <span class="nb">Get-Content</span> <span class="p">.\</span><span class="n">manifest</span><span class="p">.</span><span class="py">xml</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c"># Create a new variable using the $xml and output the export ID (GUID) and the corresponding Displayname</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="nv">$guidtogpo</span> <span class="p">=</span> <span class="nv">$xml</span><span class="p">.</span><span class="py">Backups</span><span class="p">.</span><span class="py">BackupInst</span> <span class="p">|</span> <span class="nb">Select-Object</span> <span class="vm">@</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">    <span class="vm">@</span><span class="p">{</span> <span class="n">n</span><span class="p">=</span><span class="s1">&#39;ID&#39;</span><span class="p">;</span> <span class="n">e</span><span class="p">={</span> <span class="nv">$_</span><span class="p">.</span><span class="py">ID</span><span class="p">.</span><span class="s1">&#39;#cdata-section&#39;</span> <span class="p">}}</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">    <span class="vm">@</span><span class="p">{</span> <span class="n">n</span><span class="p">=</span><span class="s1">&#39;DisplayName&#39;</span><span class="p">;</span> <span class="n">e</span><span class="p">={</span> <span class="nv">$_</span><span class="p">.</span><span class="py">GPOdisplayname</span><span class="p">.</span><span class="s1">&#39;#cdata-section&#39;</span> <span class="p">}}</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="p">)</span></span></span></code></pre></div><p>Thanks to help from the PowerShell discord I was able to unraffle the above, I was looking in the wrong direction (<code>Select-XML</code>).</p>
<p><strong>Matching GPO-ID to Displayname</strong></p>
<figure><img src="/images/guest-configuration-policy/guid-to-gpo.png"
    alt="GUID to GPO">
</figure>

<p>Configuration names can only contain alphanumerical characters and underscores, so knowing that I want to use the GPO <code>MSFT Windows Server 2004 - Member Server</code> I replaced the spaces with underscores (for the configurationname) and are going to convert the GPO to a MOF-file.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="c"># Using a regex search replace the spaces and - characters with an underscore</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="s2">&#34;MSFT Windows Server 2004 - Member Server&#34;</span> <span class="o">-replace</span> <span class="s1">&#39;[\s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="n">MSFT_Windows_Server_2004_-_Member_Server</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="c"># Convert the GPO and give the configuration the name of the GPO</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="nb">ConvertFrom-GPO</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="n">-Path</span> <span class="s1">&#39;.\{A57A9BF8-C5CC-4CBE-AC7D-A1D0746523FE}\&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="n">-ConfigName</span> <span class="s2">&#34;MSFT_Windows_Server_2004_Member_Server&#34;</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="n">-OutputConfigurationScript</span></span></span></code></pre></div><p>This conversion operation creates an Output folder by default, which contains:</p>
<ul>
<li>a configuration .ps1 (this can be used to apply your GPO-settings with Azure Automation DSC !!)</li>
<li>Managed Object Format (MOF) file (this compiled configuration is used to check the settings)</li>
</ul>
<p><strong>.MOF-file</strong></p>
<figure><img src="/images/guest-configuration-policy/mof.png"
    alt="Policy Compliance">
</figure>

<p>Yay we can finally start with setting up our Policy deployment!</p>
<h3 id="2-deploy-prerequisites-for-auditing-mechanism">2. Deploy prerequisites for auditing mechanism</h3>
<p>I assigned the initiative <code>[Preview]: Deploy prerequisites to enable Guest Configuration policies on virtual machines</code> or <code>/providers/Microsoft.Authorization/policySetDefinitions/12794019-7a00-42cf-95c2-882eed337cc8</code> so the VM&rsquo;s receive the proper pre-requisites and the long Policy wait has begun.</p>
<p>The initiative contains the following (Policies and Effect Type):</p>
<ul>
<li>Add system-assigned managed identity to enable Guest Configuration assignments on virtual machines with no identities, Modify;</li>
<li>Add system-assigned managed identity to enable Guest Configuration assignments on VMs with a user-assigned identity, Modify;</li>
<li>Deploy the Windows Guest Configuration extension to enable Guest Configuration assignments on Windows VMs, DeployIfNotExists;</li>
<li>Deploy the Linux Guest Configuration extension to enable Guest Configuration assignments on Linux VMs,DeployIfNotExists;</li>
</ul>
<p>After a while the VM&rsquo;s had a Managed Identity in Azure AD and the proper extension: <code>AzurePolicyforWindows</code>.</p>
<h3 id="3-make-a-guest-configuration-package">3. Make a guest configuration package</h3>
<p>This is pretty straight forward, we need to create a package with the .MOF-file we created in step 1 and give our Guest Configuration policy a name.
<strong>Note</strong> that you can&rsquo;t have spaces in the name of your packages (this kept me busy for a few weeks).</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">New-GuestConfigurationPackage</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">-Name</span> <span class="s2">&#34;MSFT_Windows_Server_2004_Member_Server&#34;</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="n">-Configuration</span> <span class="p">.\</span><span class="n">localhost</span><span class="p">.</span><span class="n">mof</span></span></span></code></pre></div><p>This creates a package which has the name as set above and a folder with the contents of the package called <code>unzippedPackage</code> it contains all the prerequisites required to perform the audit if step 2 was performed correctly.</p>
<figure><img src="/images/guest-configuration-policy/package.png"
    alt="Policy Compliance">
</figure>

<h3 id="4-test-configuration-package">4. Test Configuration Package</h3>
<p>This step is not mandatory, but can be nice to test your converted GPO if it contains all the checks you need. I&rsquo;d mostly use a machine on which you&rsquo;d want audit anyway. I bound the results of a test to a variable so results can be revisited easily:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nv">$hank</span> <span class="p">=</span> <span class="nb">Test-GuestConfigurationPackage</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">-Path</span> <span class="s1">&#39;.\MSFT_Windows_Server_2004_Member_Server.zip&#39;</span></span></span></code></pre></div><p><strong>$hank</strong></p>
<figure><img src="/images/guest-configuration-policy/output.png"
    alt="Policy Compliance">
</figure>

<p>The outputted results arent&rsquo;t what&rsquo;s so nice, the value is in the <code>$hank.resources</code>.</p>
<p>When you check-out that one with out-gridview, it gives a nice example what the end-result will look like.</p>
<p><strong>Out-Gridview</strong></p>
<p>Results from <code>Out-Gridview $hank.resources</code></p>
<figure><img src="/images/guest-configuration-policy/ogv.png"
    alt="Policy Compliance">
</figure>

<p>This shows that we can succesfully audit the settings with the .MOF on one machine manually!
But I&rsquo;m lazy and want to make Azure Policy do the heavy lifting for me.</p>
<h3 id="5-publish-the-configuration-package-to-a-storage-container-and-produce-a-sharing-link">5. Publish the configuration package to a storage container and produce a sharing link</h3>
<p>This step initially was a bit confusing in the documentation. In the Microsoft Docs it states:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">Publish-GuestConfigurationPackage</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">-Path</span> <span class="p">./</span><span class="n">AuditBitlocker</span><span class="p">.</span><span class="py">zip</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="n">-ResourceGroupName</span>  <span class="n">myResourceGroupName</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="n">-StorageAccountName</span> <span class="n">myStorageAccountName</span></span></span></code></pre></div><p>Filling in my information I received errors which stated:</p>
<ul>
<li>The specified container does not exist.</li>
</ul>
<p>I wasn&rsquo;t sure which container it couldn&rsquo;t find. One look in the .psm1 file and I found that the storageaccount container by default is named <code>guestcontainer</code>. Later I thought why bother looking there if <code>Get-Help</code> also would suffice, doh!</p>
<p>I went the easy way out and just created a storage container named <code>guestcontainer</code>, but you can name it anyway you want,<code>Publish-GuestConfigurationPackage</code> has an argument <code>-StorageContainerName</code>. This allows you to be creative and give an own name to your storage container.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">Publish-GuestConfigurationPackage</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="n">-Path</span> <span class="s1">&#39;.\MSFT Windows Server 2004 - Member Server.zip&#39;</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="n">-ResourceGroupName</span> <span class="nb">christian-rsg</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="n">-StorageAccountName</span> <span class="p">&lt;</span><span class="n">name</span> <span class="n">of</span> <span class="n">my</span> <span class="n">storageaccount</span><span class="p">&gt;</span> <span class="p">`</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="n">-StorageContainerName</span> <span class="n">guestconfiguration</span></span></span></code></pre></div><p>This returns a sharing link with SAS-token, keep it close you&rsquo;ll need it later!</p>
<h3 id="6-create-an-azure-policy">6. Create an Azure Policy</h3>
<p>We&rsquo;re going to use the link + sas token, a displayname, a description, platform specifion and potentially a tag filter, and create an Azure Policy with <code>New-GuestConfigurationPolicy</code>.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"> <span class="nv">$NewGuestConfigurationPolicySplat</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">     <span class="n">ContentUri</span> <span class="p">=</span> <span class="s1">&#39;&lt;fill in your sharing link&gt;&#39;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">     <span class="n">DisplayName</span> <span class="p">=</span> <span class="s1">&#39;MSFT Windows Server 2004 - Member Server&#39;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">     <span class="n">Description</span> <span class="p">=</span> <span class="s1">&#39;Validation os-hardening baseline configuration for Windows Server (2004) Domain Members&#39;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">     <span class="n">Path</span> <span class="p">=</span> <span class="s1">&#39;./policyDefinitions&#39;</span>
</span></span><span class="line"><span class="ln">6</span><span class="cl">     <span class="n">Platform</span> <span class="p">=</span> <span class="s2">&#34;Windows&#34;</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="nb">New-GuestConfigurationPolicy</span> <span class="nv">@NewGuestConfigurationPolicySplat</span></span></span></code></pre></div><p>This creates a JSON-file (<code>AuditIfNotExists.json</code>) in the <code>Path</code> supplied in the splat. The contents of the file is the long awaited Azure Policy template!</p>
<p><strong>AuditIfNotExists.json</strong></p>
<figure><img src="/images/guest-configuration-policy/auditifnotexists.png"
    alt="Policy Compliance">
</figure>

<p>You can also immediately publish the Azure Policy, by doing <code>New-GuestConfigurationPolicy @NewGuestConfigurationPolicySplat</code>
But we didn&rsquo;t do that so we have to Publish the policy the policy by hand.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">Publish-GuestConfigurationPolicy</span> <span class="n">-Path</span> <span class="s1">&#39;.\policyDefinitions&#39;</span></span></span></code></pre></div><p>I received the output below and saw it in the Azure Policy blade, awesome!!</p>
<p><strong>Policy</strong></p>
<figure><img src="/images/guest-configuration-policy/policy.png"
    alt="VM Compliance">
</figure>

<p>This command stores the policy definition in the current PowerShell-scope (subscription, with azcontext), you could also publish the policy definition to a different scope/policy-store (maybe a Management Group).</p>
<figure><img src="/images/guest-configuration-policy/policystore.png"
    alt="Policy Store">
</figure>

<p><strong>Policy Assignment</strong></p>
<p>The custom policy is available in the store, we assign the policy to a specific resource-scope, where can differentiate in assignment names (to specify scopes) and input our parameters. In this case we can chose to audit Azure Arc machines, but this is currently not relevant for our purpose.</p>
<figure><img src="/images/guest-configuration-policy/assignment.png"
    alt="Policy Assignment">
</figure>

<p>It took a while for all VM&rsquo;s to be processed, it stated for a long time:</p>
<p><em>Reason for non-compliance
No related resources match the effect details in the policy definition.</em></p>
<p>So a nice bowl of spaghetti later, and the details pane of the VM showed a new item:</p>
<ul>
<li>Last evaluated resource (out of 1) with a clickable resource-id.</li>
</ul>
<p>This gives the nice overview over all VM&rsquo;s with a drilldown on settings, this is exactly what I needed and what I&rsquo;d expect from an integrated tool to assess compliance of each setting. I really like it, it ticks all the boxes for the said challenge.</p>
<p><strong>Policy Compliance</strong></p>
<figure><img src="/images/guest-configuration-policy/policycomplianceoverviewnew.png"
    alt="Policy Compliance">
</figure>

<p><strong>VM Compliance details overview</strong></p>
<figure><img src="/images/guest-configuration-policy/vmdetailsnew.png"
    alt="VM Compliance">
</figure>

<p><strong>VM Compliance</strong></p>
<figure><img src="/images/guest-configuration-policy/vmcompliance.png"
    alt="VM Compliance">
</figure>

<h2 id="conclusion-and-next-steps">Conclusion and next steps</h2>
<p>By converting the GPO&rsquo;s to .MOF, packaging them and applying them to audit OS-settings, we&rsquo;ve a method to check our OS-hardening using DSC and Azure Policy.
Using this feature of Azure Policy you can check compliance and drill down on specific settings, or test your security baseline vs. a reference without applying it directly.
The examples used were the Microsoft Windows Security Baselines, but you could as well use something internal or something like the CIS GPO&rsquo;s.
Next steps are automating deployment to customers with tag filtering and creating a build pipeline when a new security policy is designed!</p>
]]></content:encoded>
    </item>
  </channel>
</rss>
