<!DOCTYPE html>
<html lang="en-US">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="http://localhost:1313/images/favicon-32x32.png" />
<title>Automating GitHub operations using GitHub Apps and Azure KeyVault | Azure and DevOops</title>
<meta name="title" content="Automating GitHub operations using GitHub Apps and Azure KeyVault" />
<meta name="description" content="An view into GitHub Apps, their usecases and authentication" />
<meta name="author" content="Christian Piet" />
<meta name="keywords" content="GitHub,GitHub Apps,tokens," />






  
  <meta property="og:url" content="http://localhost:1313/posts/githubapp/">
  <meta property="og:site_name" content="Azure and DevOops">
  <meta property="og:title" content="Automating GitHub operations using GitHub Apps and Azure KeyVault">
  <meta property="og:description" content="An view into GitHub Apps, their usecases and authentication">
  <meta property="og:locale" content="en_US">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-02-14T19:41:37+01:00">
    <meta property="article:modified_time" content="2024-02-14T19:41:37+01:00">
    <meta property="article:tag" content="GitHub">
    <meta property="article:tag" content="GitHub Apps">
    <meta property="article:tag" content="Tokens">
    <meta property="og:image" content="http://localhost:1313/images/tokens/">


  
  
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:image" content="http://localhost:1313/images/tokens/">
  <meta name="twitter:title" content="Automating GitHub operations using GitHub Apps and Azure KeyVault">
  <meta name="twitter:description" content="An view into GitHub Apps, their usecases and authentication">


  
  
  <meta itemprop="name" content="Automating GitHub operations using GitHub Apps and Azure KeyVault">
  <meta itemprop="description" content="An view into GitHub Apps, their usecases and authentication">
  <meta itemprop="datePublished" content="2024-02-14T19:41:37+01:00">
  <meta itemprop="dateModified" content="2024-02-14T19:41:37+01:00">
  <meta itemprop="wordCount" content="1856">
  <meta itemprop="image" content="http://localhost:1313/images/tokens/">
  <meta itemprop="keywords" content="GitHub,GitHub Apps,Tokens">

<meta name="referrer" content="no-referrer-when-downgrade" />

  
  <link href="/original.min.css" rel="stylesheet">

  
    
    <link href="/syntax.min.css" rel="stylesheet">
  

  

  
</head>

<body>
  <header><a class="skip-link" href="#main-content">Skip to main content</a>

<a href="/" class="title"><h1>Azure and DevOops</h1></a>
<nav>
  <a href="/">Home</a>

  <a href="/posts/">Blog</a>

<a href='http://localhost:1313/index.xml'>RSS</a>







</nav>
</header>
  <main id="main-content">

<h1>Automating GitHub operations using GitHub Apps and Azure KeyVault</h1>
<p class="byline">
  <time datetime='2024-02-14' pubdate>
    2024-02-14
  </time>
  Â· Christian Piet
</p>

<content>
  <h1 id="github-apps">GitHub Apps</h1>
<p>At the company I work at (InSpark), we had a use case for automating our operations on the GitHub platform. I used GitHub Apps to perform the actions, in this blog I will show you what I learned.</p>
<h2 id="what">What</h2>
<p>We were looking how to automate the enrollment of a new customer for our company&rsquo;s service. Enrollment meant that in a web portal, a customer would enter information, and, at the press of a button, the portal would make a single request to my tool, starting a chain of operations.</p>
<p>I had a list of operations on the GitHub platform that should be made possible from my tool:</p>
<ul>
<li>Create a secret on the repository.</li>
<li>Copy template folder structure</li>
<li>Create a few new files in the new folder.</li>
<li>Create a new workflow.</li>
<li>Start a workflow with information from the request.</li>
</ul>
<h2 id="platform">Platform</h2>
<p>With my PowerShell background, I started looking into GitHub scripts and soon found that they did not fit my use case exactly. I found the REST API reference (GitHub REST API documentation - GitHub Docs), which does what I needed it to. I started looking into the REST API and wondered how to make a script interact with it headlessly. This service must be fast, available 24/7, and easily extendable, so Azure Automation was out of the question. I had yet to gain experience using Azure Functions, though.</p>
<p>I created an Azure Function and was puzzled. Am I going to use a Personal Access Token (PAT) and have every action attributed to my account, or do it in a more sophisticated way? In Azure DevOps, service accounts with PATs used to be an ugly workaround for the lack of SPN support.</p>
<p>PATs are always user-account bound, sometimes scoped, and expire when you don&rsquo;t want them to. If I win the lottery someday, I hope my colleagues don&rsquo;t pull too hairs out on the search which PAT expired where. So I wanted something else for my new shiny project.</p>
<blockquote>
<p>Entra ID SPNs can now integrate with Azure DevOps since a few months ago, and it works excellent <a href="https://learn.microsoft.com/en-us/azure/devops/release-notes/2023/sprint-228-update#managed-identity-and-service-principal-support-for-azure-devops-now-in-general-availability-ga">Managed identity and service principal support for Azure DevOps now in general availability (GA)</a>. This video by John Savill explains it in detail: <a href="https://www.youtube.com/watch?v=saTUeR_U3lA">Azure DevOps Workload Identity Federation with Azure Overview. NO MORE SECRETS!</a></p>
</blockquote>
<h2 id="github-app">GitHub App</h2>
<p>I looked to see if GitHub supported an extension from Microsoft Entra ID, so I could invite/register an Entra ID SPN to do these actions instead of everything attributed to my GitHub user with a PAT. Unfortunately, the GitHub platform doesn&rsquo;t support Entra ID SPNs as an entity, but GitHub has its own SPN implementation on its platform called a GitHub App.</p>
<p>I found documentation and started reading in on them at GitHub Apps overview - GitHub Docs. GitHub Apps are identities/apps that can act on it&rsquo;s own behalf or behalf of a user. This GitHub App can authenticate itself and call the REST API.
First, we needed to register a new GitHub App, which you can read about here: <a href="https://docs.github.com/en/apps/creating-github-apps/registering-a-github-app/registering-a-github-app">Registering a GitHub App - GitHub Docs</a>.</p>
<ul>
<li>I gave my GitHub app a name.</li>
<li>I gave the GitHub app a homepage URL (a reference to our company).</li>
<li>I didn&rsquo;t need anything related to users. So, I removed everything related to user flows and users.</li>
<li>There was no need for feedback on the PoC, so the webhook feedback was out, too.</li>
</ul>
<p>Based on the REST API documentation, I had a good idea of what repository permissions we required (it&rsquo;s fantastic on GitHub). So, we chose the required permissions based on the least privilege principle with the REST API documented requirements.
And lastly, I chose that you can only install the GitHub App on our demo org.
From there, we have a GitHub App. It was present in the GitHub Organization, and after registering the GitHub App, GitHub automatically forwards you to the overview of your GitHub App.</p>
<h2 id="authentication">Authentication</h2>
<p>The overview shows you details like Owned by (your organization or user, depending on where you created it), your App-ID, and a Client ID. This App ID is essential because you&rsquo;ll need it later.</p>
<p>GitHub has a 2 step authentication. Authentication to the GitHub Platform as the GitHub App is documentated as:</p>
<blockquote>
<p>To authenticate as itself, the app will use a JSON Web Token (JWT).
Your app should authenticate as itself when it needs to generate an installation access token. An installation access token is required to authenticate as an app installation.
Your app should also authenticate as itself when it needs to make API requests to manage resources related to the app.</p>
</blockquote>
<p>So first, we need to write some code to generate a JWT; with that JWT, we can authenticate to GitHub, request an installation token, and then make API requests. However, I had yet to learn what an installation token is.
I had to look it up, but your app&rsquo;s installed instance (at an organization) has an installation ID. The installation is the registration of the app in an organization. GitHub gives the following guidance to find the Installation ID:
You can also use the REST API to find the installation ID for an installation of your app. For example, you can get an installation ID with the GET /users/{username}/installation, GET /repos/{owner}/{repo}/installation, GET /orgs/{org}/installation, or GET /app/installations endpoints.</p>
<p>Secondly, you&rsquo;ll have to create an installation token to authenticate to that organization and fetch the access_tokens_url token.</p>
<figure><img src="/images/githubapp/auth.png"
    alt="Auth dance for GitHub App as an Installation">
</figure>

<p>In short:</p>
<ul>
<li>Create a JWT and send a request to <code>https://api.github.com/app/installations</code>, <code>/orgs/{org}/installation</code> or <code>/repos/{owner}/{repo}/installation</code></li>
<li>Find the correct installation in the response and its access_tokens_url</li>
<li>Call the access_tokens_url and receive an installation token</li>
<li>Call all the repo APIs</li>
</ul>
<h2 id="creating-a-jwt">Creating a JWT</h2>
<p>Creating JWT&rsquo;s sounds more scary than it is. You can download a private key to sign your JWT.
Luckily, a PowerShell module author already thought about all of these things. I tried using <a href="https://github.com/Nucleware/powershell-jwt">powershell-jwt</a>, which worked great, but unfortunately it required me to have the private key of my GitHub App locally on my host running my PowerShell code.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nb">Install-PSResource</span> <span class="s1">&#39;powershell-jwt&#39;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nv">$newjwtSplat</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">    <span class="n">Algorithm</span> <span class="p">=</span> <span class="s2">&#34;RS256&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="n">SecretKey</span> <span class="p">=</span> <span class="p">(</span><span class="nb">Get-Content</span> <span class="p">/</span><span class="n">Users</span><span class="p">/</span><span class="n">christian</span><span class="p">/</span><span class="n">Downloads</span><span class="p">/</span><span class="n">mykey</span><span class="p">.</span><span class="mf">2023</span><span class="p">-</span><span class="mf">07</span><span class="p">-</span><span class="mf">31</span><span class="p">.</span><span class="nb">private-key</span><span class="p">.</span><span class="py">pem</span> <span class="n">-AsByteStream</span><span class="p">)</span> <span class="c"># This accepts a byte-array</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="n">Issuer</span> <span class="p">=</span> <span class="s2">&#34;123456&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="n">ExpiryTimestamp</span> <span class="p">=</span> <span class="p">([</span><span class="no">math</span><span class="p">]::</span><span class="n">Round</span><span class="p">((</span><span class="nb">Get-Date</span> <span class="n">-UFormat</span> <span class="k">%</span><span class="n">s</span><span class="p">))</span> <span class="p">+</span> <span class="p">(</span><span class="mf">8</span> <span class="p">*</span> <span class="mf">60</span><span class="p">))</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="nb">New-JWT</span> <span class="nv">@newjwtSplat</span></span></span></code></pre></div><p>Since I dove into this authentication dance GitHub updated their docs to provides a similar endresult:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="c">#!/usr/bin/env pwsh</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="nv">$app_id</span> <span class="p">=</span> <span class="n">YOUR_APP_ID</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="nv">$private_key_path</span> <span class="p">=</span> <span class="s2">&#34;YOUR_PATH_TO_PEM&#34;</span>
</span></span><span class="line"><span class="ln">5</span><span class="cl">
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="nv">$header</span> <span class="p">=</span> <span class="p">[</span><span class="no">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">([</span><span class="no">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8</span><span class="p">.</span><span class="py">GetBytes</span><span class="p">((</span><span class="nb">ConvertTo-Json</span> <span class="n">-InputObject</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">  <span class="n">alg</span> <span class="p">=</span> <span class="s2">&#34;RS256&#34;</span>
</span></span><span class="line"><span class="ln">8</span><span class="cl">  <span class="n">typ</span> <span class="p">=</span> <span class="s2">&#34;JWT&#34;</span>
</span></span><span class="line"><span class="ln">9</span><span class="cl"><span class="p">}))).</span><span class="py">TrimEnd</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">).</span><span class="py">Replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">).</span><span class="py">Replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">);</span></span></span></code></pre></div><p>Create the JWT Header</p>
<ol>
<li>Convert the hashtable to JSON</li>
<li>Convert to a Base 64 string</li>
<li>Remove the ending <code>=</code>, replace <code>+</code> with <code>-</code> and <code>/</code> with <code>_</code>, to make the string base64Url encoded</li>
<li>Bind it to a variable named $header</li>
</ol>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nv">$payload</span> <span class="p">=</span> <span class="p">[</span><span class="no">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">([</span><span class="no">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8</span><span class="p">.</span><span class="py">GetBytes</span><span class="p">((</span><span class="nb">ConvertTo-Json</span> <span class="n">-InputObject</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">  <span class="n">iat</span> <span class="p">=</span> <span class="p">[</span><span class="no">System.DateTimeOffset</span><span class="p">]::</span><span class="n">UtcNow</span><span class="p">.</span><span class="py">AddSeconds</span><span class="p">(</span><span class="mf">-10</span><span class="p">).</span><span class="py">ToUnixTimeSeconds</span><span class="p">()</span>  
</span></span><span class="line"><span class="ln">3</span><span class="cl">  <span class="n">exp</span> <span class="p">=</span> <span class="p">[</span><span class="no">System.DateTimeOffset</span><span class="p">]::</span><span class="n">UtcNow</span><span class="p">.</span><span class="py">AddMinutes</span><span class="p">(</span><span class="mf">10</span><span class="p">).</span><span class="py">ToUnixTimeSeconds</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">  <span class="n">iss</span> <span class="p">=</span> <span class="nv">$app_id</span>    
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="p">}))).</span><span class="py">TrimEnd</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">).</span><span class="py">Replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">).</span><span class="py">Replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">);</span></span></span></code></pre></div><p>Create the JWT Payload</p>
<ol start="5">
<li>Convert the hashtable to JSON (mind the app-id)</li>
<li>Convert to a base64 string</li>
<li>Also make this string base64 url encoded</li>
<li>Bind it to a variable named $payload</li>
</ol>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nv">$rsa</span> <span class="p">=</span> <span class="p">[</span><span class="no">System.Security.Cryptography.RSA</span><span class="p">]::</span><span class="n">Create</span><span class="p">()</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nv">$rsa</span><span class="p">.</span><span class="py">ImportFromPem</span><span class="p">((</span><span class="nb">Get-Content</span> <span class="nv">$private_key_path</span> <span class="n">-Raw</span><span class="p">))</span></span></span></code></pre></div><p>Create a RSA object and import the private-key</p>
<ol start="9">
<li>Create a System.Security.Cryptography.RSA object</li>
<li>Import private key into the $rsa-object</li>
</ol>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nv">$signature</span> <span class="p">=</span> <span class="p">[</span><span class="no">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$rsa</span><span class="p">.</span><span class="py">SignData</span><span class="p">([</span><span class="no">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8</span><span class="p">.</span><span class="py">GetBytes</span><span class="p">(</span><span class="s2">&#34;</span><span class="nv">$header</span><span class="s2">.</span><span class="nv">$payload</span><span class="s2">&#34;</span><span class="p">),</span> <span class="p">[</span><span class="no">System.Security.Cryptography.HashAlgorithmName</span><span class="p">]::</span><span class="n">SHA256</span><span class="p">,</span> <span class="p">[</span><span class="no">System.Security.Cryptography.RSASignaturePadding</span><span class="p">]::</span><span class="n">Pkcs1</span><span class="p">)).</span><span class="py">TrimEnd</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">).</span><span class="py">Replace</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">).</span><span class="py">Replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span></span></span></code></pre></div><p>Create a signature string</p>
<ol start="11">
<li>Concatenate $header and $payload with a period and create a byte-array</li>
<li>Create a HashAlgorithmName instance representing the SHA256 hash algorithm.</li>
<li>Use PKCS padding for the plaintext</li>
<li>Convert the resulting byte-array to Base64 string</li>
<li>Make the signature string base64 url encoded</li>
</ol>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln">1</span><span class="cl"><span class="nv">$jwt</span> <span class="p">=</span> <span class="s2">&#34;</span><span class="nv">$header</span><span class="s2">.</span><span class="nv">$payload</span><span class="s2">.</span><span class="nv">$signature</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="nb">Write-Host</span> <span class="nv">$jwt</span></span></span></code></pre></div><ol start="16">
<li>Concat the header, payload and signature</li>
<li>Output the JWT to the console and information stream</li>
</ol>
<p>So the result is the same, with a locally stored private key you can make your own JWT&rsquo;s very cool.</p>
<p>With this JWT we could request an installation token:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$PSCmdlet</span><span class="p">.</span><span class="py">ShouldProcess</span><span class="p">(</span><span class="s2">&#34;Requesting GitHub App Installations using JWT&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="nv">$invokeRestMethodSplat</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="n">Uri</span>     <span class="p">=</span> <span class="s1">&#39;https://api.github.com/app/installations&#39;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="n">Headers</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">            <span class="n">Accept</span>                 <span class="p">=</span> <span class="s2">&#34;application/vnd.github+json&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">            <span class="n">Authorization</span>          <span class="p">=</span> <span class="s2">&#34;Bearer </span><span class="nv">$JWT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">            <span class="s2">&#34;X-GitHub-Api-Version&#34;</span> <span class="p">=</span> <span class="s2">&#34;2022-11-28&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="nv">$Installations</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="nv">@invokeRestMethodSplat</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="nv">$Installations</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">            <span class="k">throw</span> <span class="s2">&#34;Could not get installations with JWT&#34;</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="k">throw</span> <span class="nv">$_</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="nv">$AccessTokensUrl</span> <span class="p">=</span> <span class="p">(</span><span class="nv">$Installations</span><span class="p">).</span><span class="py">access_tokens_url</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nv">$PSCmdlet</span><span class="p">.</span><span class="py">ShouldProcess</span><span class="p">(</span><span class="s2">&#34;Requesting GitHub Repo token using JWT&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="nv">$irmSplat</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">        <span class="n">Uri</span>     <span class="p">=</span> <span class="nv">$AccessTokensUrl</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">        <span class="n">Method</span>  <span class="p">=</span> <span class="s1">&#39;Post&#39;</span>
</span></span><span class="line"><span class="ln">29</span><span class="cl">        <span class="n">Headers</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">            <span class="n">Accept</span>                 <span class="p">=</span> <span class="s2">&#34;application/vnd.github+json&#34;</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">            <span class="n">Authorization</span>          <span class="p">=</span> <span class="s2">&#34;Bearer </span><span class="nv">$JWT</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">32</span><span class="cl">            <span class="s2">&#34;X-GitHub-Api-Version&#34;</span> <span class="p">=</span> <span class="s2">&#34;2022-11-28&#34;</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">        <span class="nv">$installationToken</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="nv">@irmSplat</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">        <span class="k">if</span> <span class="p">(!</span><span class="nv">$installationToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">            <span class="k">throw</span> <span class="s2">&#34;Could not get GitHub Repo token&#34;</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">        <span class="k">throw</span> <span class="nv">$_</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl"><span class="nv">$installationToken</span></span></span></code></pre></div><p>This <code>$installationToken</code> has our wanted installation token, the permissions the token has.</p>
<p>Finally we can call the REST API as we&rsquo;re used to:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nv">$Organization</span> <span class="p">=</span> <span class="s1">&#39;Manbearpiet&#39;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="nv">$RepositoryName</span> <span class="p">=</span> <span class="s1">&#39;Manbearpiet&#39;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="nv">$Path</span> <span class="p">=</span> <span class="s1">&#39;README.MD&#39;</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="nv">$file</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="n">Uri</span>     <span class="p">=</span> <span class="s2">&#34;https://api.github.com/repos/</span><span class="nv">$Organization</span><span class="s2">/</span><span class="nv">$RepositoryName</span><span class="s2">/contents/</span><span class="nv">$Path</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">    <span class="n">Method</span>  <span class="p">=</span> <span class="s1">&#39;Get&#39;</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="n">Headers</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="n">Accept</span>                 <span class="p">=</span> <span class="s2">&#34;application/vnd.github+json&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="n">Authorization</span>          <span class="p">=</span> <span class="s2">&#34;Bearer </span><span class="p">$(</span><span class="nv">$installationToken</span><span class="p">.</span><span class="n">token</span><span class="p">)</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="s2">&#34;X-GitHub-Api-Version&#34;</span> <span class="p">=</span> <span class="s2">&#34;2022-11-28&#34;</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="nb">Invoke-RestMethod</span> <span class="nv">@file</span></span></span></code></pre></div><h3 id="azure-keyvault">Azure KeyVault</h3>
<p>Since the Azure Functions host is a public webserver, I intensely disliked storing my private key file locally on that host&rsquo;s filesystem. We usually store our private keys on a Microsoft-hosted secret vault, the Azure Key Vault-service. After much tinkering with Base64 Url Encoded strings and getting a last push over the hill with the hash, thanks again to Drew of the PowerShell Discord, I had a valid JWT signature using this code:</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kd">function</span><span class="w"> </span><span class="nb">New-AZKVTokenSignature</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">    <span class="p">[</span><span class="nb">CmdletBinding</span><span class="p">(</span><span class="na">SupportsShouldProcess</span><span class="p">)]</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl">    <span class="k">param</span> <span class="p">(</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">        <span class="p">[</span><span class="nb">Parameter</span><span class="p">(</span><span class="na">Mandatory</span><span class="p">)]</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">        <span class="p">[</span><span class="no">String</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">        <span class="nv">$JWT</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">        <span class="p">[</span><span class="nb">Parameter</span><span class="p">()]</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">        <span class="p">[</span><span class="no">String</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">        <span class="nv">$KeyVaultName</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">        <span class="p">[</span><span class="nb">Parameter</span><span class="p">()]</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">        <span class="p">[</span><span class="no">String</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">        <span class="nv">$PrivateKeyName</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="p">[</span><span class="nb">Parameter</span><span class="p">()]</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">        <span class="p">[</span><span class="no">String</span><span class="p">]</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="nv">$PrivateKeyVersion</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$PSCmdlet</span><span class="p">.</span><span class="py">ShouldProcess</span><span class="p">(</span><span class="s2">&#34;Requesting KeyVault api acess token&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">            <span class="nv">$KeyVaultToken</span> <span class="p">=</span> <span class="nb">Get-AzAccessToken</span> <span class="n">-ResourceTypeName</span> <span class="n">KeyVault</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">            <span class="k">if</span> <span class="p">(!</span><span class="nv">$KeyVaultToken</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl">                <span class="k">throw</span> <span class="s2">&#34;Could not get KeyVault token&#34;</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">            <span class="k">throw</span> <span class="nv">$_</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">26</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">    <span class="nv">$JwsResultAsByteArr</span> <span class="p">=</span> <span class="p">[</span><span class="no">System.Text.Encoding</span><span class="p">]::</span><span class="n">UTF8</span><span class="p">.</span><span class="py">GetBytes</span><span class="p">(</span><span class="nv">$JWT</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">28</span><span class="cl">
</span></span><span class="line"><span class="ln">29</span><span class="cl">    <span class="c"># Signing requires the hash of the JWT at this point (which should include the header)</span>
</span></span><span class="line"><span class="ln">30</span><span class="cl">    <span class="nv">$hash</span> <span class="p">=</span> <span class="p">[</span><span class="no">System.Security.Cryptography.SHA256</span><span class="p">]::</span><span class="n">Create</span><span class="p">().</span><span class="py">ComputeHash</span><span class="p">(</span><span class="nv">$JwsResultAsByteArr</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">
</span></span><span class="line"><span class="ln">32</span><span class="cl">    <span class="nv">$hash64</span> <span class="p">=</span> <span class="p">[</span><span class="no">Convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">(</span><span class="nv">$hash</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">33</span><span class="cl">
</span></span><span class="line"><span class="ln">34</span><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nv">$PSCmdlet</span><span class="p">.</span><span class="py">ShouldProcess</span><span class="p">(</span><span class="nv">$KeyVaultName</span><span class="p">,</span> <span class="s2">&#34;Requesting JWT signing operation from KeyVault with </span><span class="nv">$PrivateKeyName</span><span class="s2">&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">35</span><span class="cl">        <span class="nv">$irmSplat</span> <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">36</span><span class="cl">            <span class="n">Method</span>      <span class="p">=</span> <span class="s1">&#39;Post&#39;</span>
</span></span><span class="line"><span class="ln">37</span><span class="cl">            <span class="n">Headers</span>     <span class="p">=</span> <span class="vm">@</span><span class="p">{</span><span class="n">Authorization</span> <span class="p">=</span> <span class="s2">&#34;Bearer </span><span class="p">$(</span><span class="nv">$KeyVaultToken</span><span class="p">.</span><span class="n">Token</span><span class="p">)</span><span class="s2">&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="ln">38</span><span class="cl">            <span class="n">Body</span>        <span class="p">=</span> <span class="vm">@</span><span class="p">{</span>
</span></span><span class="line"><span class="ln">39</span><span class="cl">                <span class="n">alg</span>   <span class="p">=</span> <span class="s1">&#39;RS256&#39;</span>
</span></span><span class="line"><span class="ln">40</span><span class="cl">                <span class="n">value</span> <span class="p">=</span> <span class="nv">$hash64</span>
</span></span><span class="line"><span class="ln">41</span><span class="cl">            <span class="p">}</span> <span class="p">|</span> <span class="nb">ConvertTo-Json</span>
</span></span><span class="line"><span class="ln">42</span><span class="cl">            <span class="n">ContentType</span> <span class="p">=</span> <span class="s2">&#34;application/json&#34;</span>
</span></span><span class="line"><span class="ln">43</span><span class="cl">            <span class="n">Uri</span>         <span class="p">=</span> <span class="s2">&#34;https://</span><span class="nv">$KeyVaultName</span><span class="s2">.vault.azure.net/keys/</span><span class="nv">$PrivateKeyName</span><span class="s2">/</span><span class="nv">$PrivateKeyVersion</span><span class="s2">/sign?api-version=7.4&#34;</span>
</span></span><span class="line"><span class="ln">44</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">45</span><span class="cl">
</span></span><span class="line"><span class="ln">46</span><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">47</span><span class="cl">            <span class="nv">$signature</span> <span class="p">=</span> <span class="nb">Invoke-RestMethod</span> <span class="nv">@irmSplat</span>
</span></span><span class="line"><span class="ln">48</span><span class="cl">            <span class="k">if</span> <span class="p">(!</span><span class="nv">$signature</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">49</span><span class="cl">                <span class="k">throw</span> <span class="s2">&#34;Could not get signature from KeyVault&#34;</span>
</span></span><span class="line"><span class="ln">50</span><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="ln">51</span><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">52</span><span class="cl">            <span class="k">throw</span> <span class="nv">$_</span>
</span></span><span class="line"><span class="ln">53</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">54</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">55</span><span class="cl">    <span class="s2">&#34;{0}.{1}&#34;</span> <span class="o">-f</span> <span class="nv">$JWT</span><span class="p">,</span> <span class="nv">$signature</span><span class="p">.</span><span class="py">value</span>
</span></span><span class="line"><span class="ln">56</span><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>I could call my installations and retrieve a short-living installation token. AWESOME!</p>
<p>Automating all the things
In PowerShell, we can extend the built-in functionality with modules, so I firmly hoped that someone would support operation on the platform with a GitHub app. Unfortunately, this wasn&rsquo;t the case with the few modules I checked out, so I was off to make my code. The lack of a module supporting this resulted in the PowerShell module handling GitHub operations: GitHubPowerShell.</p>

</content>
<p>
  
    <a class="blog-tags" href="/tags/github/">#github</a>
  
    <a class="blog-tags" href="/tags/github-apps/">#github apps</a>
  
    <a class="blog-tags" href="/tags/tokens/">#tokens</a>
  
</p>




  </main>
  <footer><small>
  Christian Piet (CC BY 4.0) | Made with <a href="https://github.com/clente/hugo-bearcub">Bear Cub</a>
</small></footer>

    
</body>

</html>
